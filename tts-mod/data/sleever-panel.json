{
  "GUID": "d2ccb3",
  "Name": "Custom_Token",
  "Transform": {
    "posX": -0.000222661984,
    "posY": 1.01000023,
    "posZ": 0.00157909153,
    "rotX": 6.786143e-7,
    "rotY": 180,
    "rotZ": -2.445652e-7,
    "scaleX": 3.89,
    "scaleY": 1,
    "scaleZ": 3.89
  },
  "Nickname": "Flexible Card Sleever 1.1.0",
  "Description": "[BB3030][b]Red buttons[/b][-] are extra/experimenal functionalities.\r\n\r\n[b]Workshop link:[/b] https://steamcommunity.com/sharedfiles/filedetails/?id=2961122291\r\n",
  "GMNotes": "",
  "AltLookAngle": {
    "x": 0,
    "y": 0,
    "z": 0
  },
  "ColorDiffuse": {
    "r": 1,
    "g": 1,
    "b": 1
  },
  "LayoutGroupSortIndex": 0,
  "Value": 0,
  "Locked": false,
  "Grid": false,
  "Snap": false,
  "IgnoreFoW": false,
  "MeasureMovement": false,
  "DragSelectable": false,
  "Autoraise": true,
  "Sticky": true,
  "Tooltip": false,
  "GridProjection": false,
  "HideWhenFaceDown": false,
  "Hands": false,
  "CustomImage": {
    "ImageURL": "https://steamusercontent-a.akamaihd.net/ugc/12790355751378578453/2B22E01405A46AAA979C06160FEA67A0D61547CB/",
    "ImageSecondaryURL": "",
    "ImageScalar": 1,
    "WidthScale": 0,
    "CustomToken": {
      "Thickness": 0.1,
      "MergeDistancePixels": 15,
      "StandUp": false,
      "Stackable": false
    }
  },
  "LuaScript": "-- Author: Vitor Sousa (vitorsousasilvas@gmail.com)\r\n-- Workshop: https://steamcommunity.com/sharedfiles/filedetails/?id=2961122291\r\n-- GitHub: https://github.com/vitorsousasilva/flexibe-card-sleever\r\n\r\n-- Observations:\r\n-- * 'cde' stands for \"Card, Deck or Equivalent\"\r\n\r\n--------------------\r\n-- lua aux functions\r\n\r\nlocal function tableMergeShallow(lhs, rhs)\r\n  for key, value in pairs(rhs) do\r\n    lhs[key] = value\r\n  end\r\n  return lhs\r\nend\r\n\r\nlocal function isNonEmptyString(str)\r\n  return str and str ~= \"\" and type(str) == \"string\"\r\nend\r\n\r\n-------------------\r\n-- Global constants\r\n\r\nlocal SLEEVE_COPY_MODE_BACK = \"BackURL\"\r\nlocal SLEEVE_COPY_MODE_FACE = \"FaceURL\"\r\nlocal SLEEVE_COPY_MODE_SIDE_UP = -1\r\n\r\nlocal SLEEVE_WRITE_TO_BACK = \"BackURL\"\r\nlocal SLEEVE_WRITE_TO_FACE = \"FaceURL\"\r\n\r\n-- local MIRROR_MODE_BACK_TO_FACE = 0\r\n-- local MIRROR_MODE_FACE_TO_BACK = 1\r\n\r\nlocal COLOR_ERROR = {211, 9, 9}\r\nlocal COLOR_WARN = {202, 202, 22}\r\n\r\n--------------------\r\n-- tts aux functions\r\n\r\nlocal function getCdeAt(relative_position)\r\n  local world_position = self:positionToWorld(relative_position)\r\n  local hits = Physics.cast({\r\n    origin = world_position,\r\n    direction = {0, 1, 0},\r\n    max_distance = 0,\r\n    type = 3, -- box\r\n    size = {1, 1, 1},\r\n    debug = false,\r\n  })\r\n  for index_, hit in ipairs(hits) do\r\n    if hit.hit_object.type == \"Deck\" or hit.hit_object.type == \"Card\" then\r\n      return hit.hit_object\r\n    end\r\n  end\r\n  return nil\r\nend\r\n\r\nlocal function updateCustomDeckEntryBackFields(entry, url)\r\n  entry.BackURL = url\r\n  entry.UniqueBack = false\r\nend\r\n\r\nlocal function updateCustomDeckEntryFaceFields(entry, url)\r\n  entry.FaceURL = url\r\n  entry.NumWidth = 1\r\n  entry.NumHeight = 1\r\n  entry.BackIsHidden = true\r\n  entry.UniqueBack = false\r\nend\r\n\r\nlocal function updateCdeCustomDeckBackFields(cde_data, url)\r\n  if not cde_data.CustomDeck then\r\n    return\r\n  end\r\n  for key_, entry in pairs(cde_data.CustomDeck) do\r\n    updateCustomDeckEntryBackFields(entry, url)\r\n  end\r\nend\r\n\r\nlocal function updateCdeCustomDeckFaceFields(cde_data, url)\r\n  if not cde_data.CustomDeck then\r\n    return\r\n  end\r\n  for key_, entry in pairs(cde_data.CustomDeck) do\r\n    updateCustomDeckEntryFaceFields(entry, url)\r\n  end\r\nend\r\n\r\nlocal function updateCdeItems(cde_data, url, write_to)\r\n  local update_func = nil\r\n  if write_to == SLEEVE_WRITE_TO_BACK then\r\n    update_func = updateCdeCustomDeckBackFields\r\n  elseif write_to == SLEEVE_WRITE_TO_FACE then\r\n    update_func = updateCdeCustomDeckFaceFields\r\n  else\r\n    error(\"Invalid sleeve write mode: \" .. tostring(write_to))\r\n    return\r\n  end\r\n  local cde_type_name = cde_data.Name\r\n  if cde_type_name == \"Card\" or cde_type_name == \"CardCustom\" then\r\n    update_func(cde_data, url) -- Single cards can have a CustomDeck field\r\n  elseif cde_type_name == \"Deck\" or cde_type_name == \"DeckCustom\" then\r\n    update_func(cde_data, url)\r\n    for key_, card in pairs(cde_data.ContainedObjects) do\r\n      update_func(card, url)\r\n    end\r\n  else\r\n    error(\"Invalid object of type: \" .. tostring(cde_type_name))\r\n  end\r\nend\r\n\r\nlocal function getSleeveUrlFromCdeData(cde_data, field)\r\n  local any_nonfirst_index = false\r\n  local any_invalid_field = false\r\n  local sleeve_url = nil\r\n  for key_, entry in pairs(cde_data.CustomDeck) do\r\n    local nonfirst_index = false\r\n    local invalid_field = false\r\n    if entry.NumWidth ~= 1 or entry.NumHeight ~= 1 then\r\n      if field == SLEEVE_COPY_MODE_FACE or (entry.UniqueBack and field == SLEEVE_COPY_MODE_BACK) then\r\n        any_nonfirst_index = true\r\n        nonfirst_index = true\r\n      end\r\n    end\r\n    if not entry[field] then\r\n      any_invalid_field = true\r\n      invalid_field = true\r\n    end\r\n    if not (nonfirst_index or invalid_field) then\r\n      sleeve_url = entry[field]\r\n      break\r\n    end\r\n  end\r\n  if any_nonfirst_index then\r\n    log(\"Warning! Not supported. Some entry uses a non-first index.\")\r\n  end\r\n  if any_invalid_field then\r\n    log(\"Warning! Some entry has an invalid URL field.\")\r\n  end\r\n  if not sleeve_url then\r\n    printToAll(\"Error: Could not find any valid sleeve image URL.\", COLOR_ERROR)\r\n  end\r\n  return sleeve_url\r\nend\r\n\r\nlocal function getSleeveUrlFromCde(cde, copy_mode)\r\n  local cde_data = cde:getData()\r\n  if not cde_data.CustomDeck then\r\n    printToAll(\"Base sleeve does not have a 'CustomDeck' field.\", COLOR_ERROR)\r\n    return nil\r\n  end\r\n  local field = copy_mode\r\n  if field == SLEEVE_COPY_MODE_SIDE_UP then\r\n    field = ((cde.is_face_down and SLEEVE_COPY_MODE_BACK) or SLEEVE_COPY_MODE_FACE)\r\n  end\r\n  return getSleeveUrlFromCdeData(cde_data, field)\r\nend\r\n\r\nlocal function getSleeveUrlFromCdeAt(position, copy_mode)\r\n  local cde = getCdeAt(position)\r\n  if not cde then\r\n    printToAll(\"Missing input sleeve card!\", COLOR_WARN)\r\n    return nil\r\n  end\r\n  return getSleeveUrlFromCde(cde, copy_mode)\r\nend\r\n\r\nlocal function sleeveCdeAt(position_pair, sleeve_url, write_to)\r\n  local icde = getCdeAt(position_pair.input)\r\n  if not icde then\r\n    printToAll(\"Missing input deck!\", COLOR_WARN)\r\n    return\r\n  end\r\n  local cde_data = icde:getData()\r\n  updateCdeItems(cde_data, sleeve_url, write_to)\r\n  local spawn_position = self:positionToWorld(position_pair.output)\r\n  local spawn_rotation = self:getRotation()\r\n  spawn_rotation.z = spawn_rotation.z + 180 -- flip\r\n  spawnObjectData({\r\n    data = cde_data,\r\n    position = spawn_position,\r\n    rotation = spawn_rotation,\r\n  })\r\nend\r\n\r\nlocal function mirrorUpdateCustomDeckFieldsOneByOne(cde_data, mirror_mode)\r\n  -- Small jerry-rig: Mirror modes and fields inside entries are the same as the copy mode values\r\n  local field = mirror_mode -- NOTE: SIDE_UP mode unsupported\r\n  local update_card_func = nil\r\n  local update_entry_func = nil\r\n  if mirror_mode == SLEEVE_COPY_MODE_BACK then\r\n    update_entry_func = updateCustomDeckEntryFaceFields\r\n    update_card_func = updateCdeCustomDeckFaceFields\r\n  elseif mirror_mode == SLEEVE_COPY_MODE_FACE then\r\n    update_entry_func = updateCustomDeckEntryBackFields\r\n    update_card_func = updateCdeCustomDeckBackFields\r\n  else\r\n    error(\"Invalid mirror mode: \" .. tostring(mirror_mode))\r\n    return\r\n  end\r\n  local cde_type_name = cde_data.Name\r\n  if cde_type_name == \"Card\" or cde_type_name == \"CardCustom\" then\r\n    local url = getSleeveUrlFromCdeData(cde_data, field)\r\n    update_card_func(cde_data, url)\r\n  elseif cde_type_name == \"Deck\" or cde_type_name == \"DeckCustom\" then\r\n    local empty = true\r\n    if cde_data.CustomDeck then\r\n      for key_, entry in pairs(cde_data.CustomDeck) do\r\n        local url = entry[field]\r\n        update_entry_func(entry, url)\r\n        empty = false\r\n      end\r\n    end\r\n    if cde_data.ContainedObjects then\r\n      for key_, card in pairs(cde_data.ContainedObjects) do\r\n        local url = getSleeveUrlFromCdeData(card, field)\r\n        update_card_func(card, url)\r\n        empty = false\r\n      end\r\n    end\r\n    if empty then\r\n      error(\"Error: Deck does not have contained objects.\")\r\n    end\r\n  else\r\n    error(\"Invalid object of type: \" .. tostring(cde_type_name))\r\n  end\r\nend\r\n\r\nlocal function mirrorOneByOne(position_pair, mirror_mode)\r\n  local cde_item = getCdeAt(position_pair.input)\r\n  if not cde_item then\r\n    printToAll(\"Missing input deck!\", COLOR_WARN)\r\n    return\r\n  end\r\n  local cde_data = cde_item:getData()\r\n  mirrorUpdateCustomDeckFieldsOneByOne(cde_data, mirror_mode)\r\n  local spawn_position = self:positionToWorld(position_pair.output)\r\n  local spawn_rotation = cde_item:getRotation()\r\n  spawnObjectData({\r\n    data = cde_data,\r\n    position = spawn_position,\r\n    rotation = spawn_rotation,\r\n  })\r\nend\r\n\r\n-----------------------\r\n-- Assembling constants\r\n\r\nlocal INPUT_DECK_POSITION = {1.41, 0.5, 0}\r\nlocal INPUT_SLEEVE_POSITION = {0, 0.5, -0.74}\r\n\r\nlocal SPAWN_COPY_POSITION = {-1.41, 2, -0.74}\r\nlocal SPAWN_URL_POSITION = {-1.41, 2, 0.74}\r\nlocal SPAWN_MIRROR_FACES_POSITION = {1.41, 2, -0.95}\r\nlocal SPAWN_CUSTOM_CARD_POSITION = {2.8, 2, 0}\r\n\r\n-------------\r\n-- Main state\r\n\r\nlocal input_sleeve_copy_mode = SLEEVE_COPY_MODE_BACK\r\nlocal input_sleeve_url = nil\r\n\r\n----------------------------\r\n-- Main assembling functions\r\n\r\nlocal function sleeveCopyGo(write_to)\r\n  local sleeve_url = getSleeveUrlFromCdeAt(INPUT_SLEEVE_POSITION, input_sleeve_copy_mode)\r\n  if not isNonEmptyString(sleeve_url) then\r\n    printToAll(\"Could not get the sleeve URL.\", COLOR_WARN)\r\n    return\r\n  end\r\n  local position_pair = {\r\n    input = INPUT_DECK_POSITION,\r\n    output = SPAWN_COPY_POSITION,\r\n  }\r\n  sleeveCdeAt(position_pair, sleeve_url, write_to)\r\nend\r\n\r\nlocal function sleeveUrlGo(write_to)\r\n  if not isNonEmptyString(input_sleeve_url) then\r\n    printToAll(\"No url set!\", COLOR_WARN)\r\n    return\r\n  end\r\n  local position_pair = {\r\n    input = INPUT_DECK_POSITION,\r\n    output = SPAWN_URL_POSITION,\r\n  }\r\n  sleeveCdeAt(position_pair, input_sleeve_url, write_to)\r\nend\r\n\r\nlocal function mirrorCdeGo(mirror_mode)\r\n  local position_pair = {\r\n    input = INPUT_DECK_POSITION,\r\n    output = SPAWN_MIRROR_FACES_POSITION,\r\n  }\r\n  mirrorOneByOne(position_pair, mirror_mode)\r\nend\r\n\r\n--------------\r\n-- UI Triggers\r\n\r\nfunction onUiTestEvent(a_, b_, c_, d_, e_)\r\n  log(\"== onUiTestCb ==\")\r\n  log(a_)\r\n  log(b_)\r\n  log(c_)\r\n  log(d_)\r\n  log(e_)\r\n  log(\"================\")\r\nend\r\n\r\nfunction onUiSleeveCopyGoButtonClick()\r\n  sleeveCopyGo(SLEEVE_WRITE_TO_BACK)\r\nend\r\n\r\nfunction onUiSleeveUrlGoButtonClick()\r\n  sleeveUrlGo(SLEEVE_WRITE_TO_BACK)\r\nend\r\n\r\nfunction onUiSleeveCopyToFaceButtonClick()\r\n  sleeveCopyGo(SLEEVE_WRITE_TO_FACE)\r\nend\r\n\r\nfunction onUiSleeveUrlToFaceButtonClick()\r\n  sleeveUrlGo(SLEEVE_WRITE_TO_FACE)\r\nend\r\n\r\nfunction onUiMirrorBackToFaceButtonClick()\r\n  mirrorCdeGo(SLEEVE_COPY_MODE_BACK)\r\nend\r\n\r\nfunction onUiMirrorFaceToBackButtonClick()\r\n  mirrorCdeGo(SLEEVE_COPY_MODE_FACE)\r\nend\r\n\r\nfunction onUiSleeveModeToggleBackClick()\r\n  input_sleeve_copy_mode = SLEEVE_COPY_MODE_BACK\r\nend\r\n\r\nfunction onUiSleeveModeToggleFaceClick()\r\n  input_sleeve_copy_mode = SLEEVE_COPY_MODE_FACE\r\nend\r\n\r\nfunction onUiSleeveModeToggleSideUpClick()\r\n  input_sleeve_copy_mode = SLEEVE_COPY_MODE_SIDE_UP\r\nend\r\n\r\nfunction onUiCardBackUrlInputEndEdit(player_, input_str, id_)\r\n  input_sleeve_url = input_str\r\nend\r\n",
  "LuaScriptState": "",
  "XmlUI": "<Defaults>\r\n  <Text\r\n    navigation=\"None\"\r\n    color=\"#E9E8E7\"\r\n    resizeTextForBestFit=\"true\"\r\n    resizeTextMinSize=\"0.1\"\r\n    resizeTextMaxSize=\"1000\"\r\n  />\r\n  <Text\r\n    class=\"operator-txt\"\r\n    color=\"#b0b0b0\"\r\n    height=\"52\"\r\n    width=\"999\"\r\n    scale=\"0.5 0.5 0.5\"\r\n  />\r\n  <Text\r\n    class=\"radio-txt\"\r\n    textAlignment=\"UpperLeft\"\r\n    height=\"30\"\r\n    width=\"999\"\r\n    scale=\"0.5 0.5 0.5\"\r\n  />\r\n  <Text\r\n    class=\"deck-place\"\r\n    color=\"#b9b1cd\"\r\n    height=\"19\"\r\n    width=\"999\"\r\n    scale=\"0.5 0.5 0.5\"\r\n  />\r\n  <InputField\r\n    hoverClass=\"input_hover\"\r\n    lineType=\"SingleLine\"\r\n    navigation=\"None\"\r\n    placeholder=\" \"\r\n    textAlignment=\"MiddleLeft\"\r\n  />\r\n  <Toggle\r\n    navigation=\"None\"\r\n    textColor=\"#E9E8E7\"\r\n    resizeTextForBestFit=\"true\"\r\n    resizeTextMaxSize=\"1000\"\r\n    toggleWidth=\"11\"\r\n    toggleHeight=\"11\"\r\n  />\r\n  <Button\r\n    navigation=\"None\"\r\n    textAlignment=\"MiddleCenter\"\r\n    resizeTextForBestFit=\"true\"\r\n    resizeTextMinSize=\"0.1\"\r\n    resizeTextMaxSize=\"1000\"\r\n  />\r\n  <!-- colors=\"#4d3131|#664141|#220000|rgba(0.78,0.78,0.78,0.5)\" -->\r\n  <!-- colors=\"#39314d|#4c4166|#220022|rgba(0.78,0.78,0.78,0.5)\" -->\r\n  <Button\r\n    class=\"sleeve-it-btn\"\r\n    colors=\"#318c31ff|#43bf43|#220000|rgba(0.78,0.78,0.78,0.5)\"\r\n    textColor=\"#E9E8E7\"\r\n    textOutline=\"#121212\"\r\n    height=\"55\"\r\n    width=\"75\"\r\n    scale=\"0.5 0.5 0.5\"\r\n  />\r\n  <Button\r\n    class=\"mirror-it-btn\"\r\n    colors=\"#8c3131|#bf4343|#220000|rgba(0.78,0.78,0.78,0.5)\"\r\n    textColor=\"#E9E8E7\"\r\n    textOutline=\"#121212\"\r\n    height=\"60\"\r\n    width=\"60\"\r\n    scale=\"0.5 0.5 0.5\"\r\n  />\r\n  <Button\r\n    class=\"to-face-btn\"\r\n    colors=\"#8c3131|#bf4343|#220000|rgba(0.78,0.78,0.78,0.5)\"\r\n    textColor=\"#E9E8E7\"\r\n    textOutline=\"#121212\"\r\n    height=\"25\"\r\n    width=\"30\"\r\n    scale=\"0.5 0.5 0.5\"\r\n  />\r\n</Defaults>\r\n\r\n<!--<Panel id=\"uiFlexibleCardSleeverPanel\" position=\"185 -130 -10\" rotation=\"180 180 0\" width=\"500\" height=\"400\" active=\"true\"></Panel>-->\r\n<Panel rotation=\"0 0 180\" position=\"0 0 -7\">\r\n\r\n  <Text class=\"deck-place\" offsetXY=\"-141.8 31.5\">Place Deck</Text>\r\n  <Text class=\"deck-place\" offsetXY=\"-141.8 22.5\">Here</Text>\r\n  <Text class=\"deck-place\" offsetXY=\"0 101\">Sleeve</Text>\r\n\r\n  <Text class=\"operator-txt\" offsetXY=\"-87 40\">+</Text>\r\n  <Text class=\"operator-txt\" offsetXY=\"-87 -40\">+</Text>\r\n  <Text class=\"operator-txt\" offsetXY=\"87 75\">=</Text>\r\n  <Text class=\"operator-txt\" offsetXY=\"87 -75\">=</Text>\r\n\r\n  <Button class=\"mirror-it-btn\" offsetXY=\"-157 -90\" onClick=\"onUiMirrorBackToFaceButtonClick\">Copy each card back to its face</Button>\r\n  <Button class=\"mirror-it-btn\" offsetXY=\"-127 -90\" onClick=\"onUiMirrorFaceToBackButtonClick\">Copy each card face to its back</Button>\r\n\r\n  <Button class=\"to-face-btn\" offsetXY=\"87 57\" onClick=\"onUiSleeveCopyToFaceButtonClick\">to face!</Button>\r\n  <Button class=\"to-face-btn\" offsetXY=\"87 -93\" onClick=\"onUiSleeveUrlToFaceButtonClick\">to face!</Button>\r\n\r\n  <Button class=\"sleeve-it-btn\" offsetXY=\"87 97\" onClick=\"onUiSleeveCopyGoButtonClick\" tooltip=\"Sleeve using another card!\">Sleeve it!</Button>\r\n  <Button class=\"sleeve-it-btn\" offsetXY=\"87 -53\" onClick=\"onUiSleeveUrlGoButtonClick\" tooltip=\"Sleeve using image URL!\">Sleeve it!</Button>\r\n\r\n  <Text offsetXY=\"-40 26\" class=\"radio-txt\">Use:</Text>\r\n  <Text offsetXY=\"21 25\" class=\"radio-txt\">Card back</Text>\r\n  <Text offsetXY=\"20 7\" class=\"radio-txt\">Card face</Text>\r\n  <Text offsetXY=\"52.7 -11\" class=\"radio-txt\">Whichever side is up</Text>\r\n  <ToggleGroup>\r\n    <Toggle offsetXY=\"-18 25\" id=\"uiSleeveModeToggleBack\" onClick=\"onUiSleeveModeToggleBackClick\" isOn=\"true\"/>\r\n    <Toggle offsetXY=\"-18 7\" id=\"uiSleeveModeToggleFace\" onClick=\"onUiSleeveModeToggleFaceClick\"/>\r\n    <Toggle offsetXY=\"-18 -11\" id=\"uiSleeveModeToggleSideUp\" onClick=\"onUiSleeveModeToggleSideUpClick\"/>\r\n  </ToggleGroup>\r\n\r\n  <Text offsetXY=\"0 -66\" height=\"20\" width=\"3000\">Card Back URL</Text>\r\n  <InputField\r\n    offsetXY=\"0 -86\"\r\n    id=\"uiCardBackUrlInput\"\r\n    onEndEdit=\"onUiCardBackUrlInputEndEdit\"\r\n    fontSize=\"16\"\r\n    placeholder=\"Enter image URL\"\r\n    height=\"40\"\r\n    width=\"340\"\r\n    scale=\"0.4 0.4 0.4\"\r\n  />\r\n\r\n</Panel>",
  "AttachedSnapPoints": [
    {
      "Position": {
        "x": 0.0003602806,
        "y": 0.05000019,
        "z": -0.7436989
      }
    },
    {
      "Position": {
        "x": 1.41840982,
        "y": 0.05000019,
        "z": 0.000363066123
      }
    }
  ]
}
